# Gateway Service Dockerfile - gateway í´ë” êµ¬ì¡° ê¸°ë°˜
FROM python:3.11-slim

# ğŸš¨ ê°•ë ¥í•œ ìºì‹œ ë¬´íš¨í™”ë¥¼ ìœ„í•œ ARG ì¶”ê°€
ARG CACHEBUST=1
ARG BUILD_DATE=unknown

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ğŸš¨ ìºì‹œ ë¬´íš¨í™”ë¥¼ ìœ„í•œ ê°•ì œ ì¬ë¹Œë“œ ë ˆì´ì–´
RUN echo "Cache bust: $(date) - CACHEBUST=${CACHEBUST} - BUILD_DATE=${BUILD_DATE}" > /tmp/cache_bust.txt && \
    echo "ê°•ì œ ì¬ë¹Œë“œ: $(date)" && \
    cat /tmp/cache_bust.txt && \
    rm /tmp/cache_bust.txt

# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

# Python í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV PYTHONUNBUFFERED=1
ENV PYTHONPATH=/app

# ğŸš¨ ìºì‹œ ë¬´íš¨í™”ë¥¼ ìœ„í•œ ì¶”ê°€ ë ˆì´ì–´
RUN echo "Python í™˜ê²½ ì„¤ì •: $(date) - CACHEBUST=${CACHEBUST}" > /tmp/python_setup.txt && \
    rm /tmp/python_setup.txt

# ìš”êµ¬ì‚¬í•­ ë³µì‚¬ ë° ì„¤ì¹˜
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ğŸš¨ ìºì‹œ ë¬´íš¨í™”ë¥¼ ìœ„í•œ ì¶”ê°€ ë ˆì´ì–´
RUN echo "Requirements ì„¤ì¹˜ ì™„ë£Œ: $(date) - CACHEBUST=${CACHEBUST}" > /tmp/requirements_done.txt && \
    rm /tmp/requirements_done.txt

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬ (gateway/app/ í´ë”ì˜ ë‚´ìš©ì„ /app/ì— ì§ì ‘ ë³µì‚¬)
COPY app/ .

# ğŸš¨ ìºì‹œ ë¬´íš¨í™”ë¥¼ ìœ„í•œ ìµœì¢… í™•ì¸
RUN echo "ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬ ì™„ë£Œ: $(date) - CACHEBUST=${CACHEBUST}" > /tmp/app_copy_done.txt && \
    echo "=== íŒŒì¼ êµ¬ì¡° í™•ì¸ ===" && ls -la && \
    echo "=== main.py ì¡´ì¬ í™•ì¸ ===" && test -f main.py && echo "âœ… main.py exists" || echo "âŒ main.py not found" && \
    cat /tmp/app_copy_done.txt && \
    rm /tmp/app_copy_done.txt

# í¬íŠ¸ ì„¤ì •
EXPOSE 8080

# í—¬ìŠ¤ì²´í¬
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# uvicornìœ¼ë¡œ ì‹¤í–‰ (ìˆ˜ì •ëœ ê²½ë¡œ)
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8080"]